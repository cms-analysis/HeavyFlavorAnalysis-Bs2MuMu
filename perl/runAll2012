#!/usr/bin/env perl
#
# Usage: cd chains/subdir; runAll -t tarfile [-h] [-m] [-n] [-r] [-a] [-d]
# ------
#            -d                           printout only, don't do anything
#            -h                           hadd the output rootfiles
#            -C                           run crashed jobs
#            -s {mc,data,signal,norm,cs}  run jobs of a specific sample
#            -r rootdir                   place where to put output
#
# 2012/06/11 added rare backgrounds (again)
# ----------------------------------------------------------------------
# Send all questions, wishes and complaints to the 
#
# Author    Urs Langenegger <urs.langenegger@psi.ch>
#
# Modified by	Jose Lazo-Flores <Jose.Lazo-Flores@cern.ch>
# ----------------------------------------------------------------------
use Getopt::Std;
getopts('Cdhj:r:s:t:v:l:');

if ($opt_l) {
    $location = $opt_l; 
} else {
    die "===> Provide a directory name where output root file should go! Example: mc, data...\n";
}

my $job = "2012/$location";
if ($opt_j) {
    $job = $opt_j; 
}

if ($opt_v) {
    $version = $opt_v; 
} else {
    $version = "v14";
}

my $rootdir = "$version/bmm/$job"; 
if ($opt_r) {
    $rootdir = $opt_r; 
}


%jobs = (
    "signal Bs2MuMu MC mix"  
    => "-y 2012 -m,bmm2Reader.mix-Bs2MuMu,cbmm-mc-2012-v14-BsToMuMu_BsFilter_8TeV-pythia6-evtgen__Summer12_DR53X-PU_S10_START53_V7A-v1-*,$version-cms-BsToMuMu.root"
    , "signal Bd2MuMu MC mix"  
    => "-y 2012 -m,bmm2Reader.mix-Bd2MuMu,cbmm-mc-2012-v14-BdToMuMu_BdFilter_8TeV-pythia6-evtgen__Summer12_DR53X-PU_S10_START53_V7A-v1-*,$version-cms-BdToMuMu.root"
    #
    , "norm Bu2JpsiK MC mix acc"  
    => "-y 2012 -m,bmm2Reader.mix-Bu2JpsiK,cbmm-mc-2012-v14-BuToJPsiK_K2MuFilter_8TeV-pythia6-evtgen__Summer12_DR53X-PU_S10_START53_V7A-v1-*,$version-cms-accBuToJpsiK.root"
    , "norm Bu2JpsiK MC mix overl"  
    => "-y 2012 -m,bmm2Reader.mix-Bu2JpsiK,cbmm-mc-2012-v14-BuToJPsiK_K2MuPtEtaEtaFilter_8TeV-pythia6-evtgen__Summer12_DR53X-PU_S10_START53_V7A-v2-*,$version-cms-BuToJpsiK.root"
    #, "norm Bu2JpsiK MC mix 52X"  
    #=> "-y 2012 -m,bmm2Reader.mix-Bu2JpsiK,cbmm-$version-cms-BuToJPsiK_K2MuPtEtaEtaFilter-8TeV-START52_V9-v2-*,$version-cms-BuToJpsiK-52X.root"
    #
    , "cs Bs2JpsiPhi MC mix acc"  
    => "-y 2012 -m,bmm2Reader.mix-Bs2JpsiPhi,cbmm-mc-2012-v14-BsToJPsiPhi_2K2MuFilter_8TeV-pythia6-evtgen__Summer12_DR53X-PU_S10_START53_V7A-v1-*,$version-cms-accBsToJpsiPhi.root"
    , "cs Bs2JpsiPhi MC mix overl"  
    => "-y 2012 -m,bmm2Reader.mix-Bs2JpsiPhi,cbmm-mc-2012-v14-BsToJPsiPhi_2K2MuPtEtaFilter_8TeV-pythia6-evtgen__Summer12_DR53X-PU_S10_START53_V7A-v1-*,$version-cms-BsToJpsiPhi.root"
    #
	, "data 2012"  
    => "-y 2012 -b 1,bmm2Reader.2012,cbmm-$version-Run2012*,$version-2012-data.root"
	#
    , "rare Bs2KK MC"  
    => "-y 2012 -m,bmm2Reader.2e33-Bs2KK,cbmm-mc-2012-v14-BsToKK_2KPtEtaFilter_8TeV-pythia6-evtgen__Summer12_DR53X-PU_S10_START53_V7A-v1-*,$version-cms-BsToKK.root"
    , "rare Bs2KMuNu MC"  
    => "-y 2012 -m,bmm2Reader.2e33-Bs2KMuNu,cbmm-mc-2012-v14-BsToKMuNu_KMuNuEtaFilter_8TeV-pythia6-evtgen__Summer12_DR53X-PU_S10_START53_V7A-v1-*,$version-cms-BsToKMuNu.root"
    , "rare Bs2KPi MC"  
    => "-y 2012 -m,bmm2Reader.2e33-Bs2KPi,cbmm-mc-2012-v14-BsToKPi_KPiPtEtaFilter_8TeV-pythia6-evtgen__Summer12_DR53X-PU_S10_START53_V7A-v1-*,$version-cms-BsToKPi.root"
    , "rare Bs2MuMuGamma MC"  
    => "-y 2012 -m,bmm2Reader.2e33-Bs2MuMuGamma,cbmm-mc-2012-v14-BsToMuMuGamma_MuMuEtaPtGammaFilter_8TeV-pythia6-evtgen__Summer12_DR53X-PU_S10_START53_V7A-v1-*,$version-cms-BsToMuMuGamma.root"
    , "rare Bs2PiPi MC"  
    => "-y 2012 -m,bmm2Reader.2e33-Bs2PiPi,cbmm-mc-2012-v14-BsToPiPi_2PiPtEtaFilter_8TeV-pythia6-evtgen__Summer12_DR53X-PU_S10_START53_V7A-v1-*,$version-cms-BsToPiPi.root"
	#
    , "rare Bd2KK MC"  
    => "-y 2012 -m,bmm2Reader.2e33-Bd2KK,cbmm-mc-2012-v14-BdToKK_2KPtEtaFilter_8TeV-pythia6-evtgen__Summer12_DR53X-PU_S10_START53_V7A-v1-*,$version-cms-BdToKK.root"
    , "rare Bd2KPi MC"  	
    => "-y 2012 -m,bmm2Reader.2e33-Bd2KPi,cbmm-mc-2012-v14-BdToKPi_KPiPtEtaFilter_8TeV-pythia6-evtgen__Summer12_DR53X-PU_S10_START53_V7A-v1-*,$version-cms-BdToKPi.root"
    , "rare Bd2PiMuNu MC"  
    => "-y 2012 -m,bmm2Reader.2e33-Bd2PiMuNu,cbmm-mc-2012-v14-BdToPiMuNu_PiMuNuPtEtaFilter_8TeV-pythia6-evtgen__Summer12_DR53X-PU_S10_START53_V7A-v1-*,$version-cms-BdToPiMuNu.root"
    , "rare Bd2PiPi MC"  
    => "-y 2012 -m,bmm2Reader.2e33-Bd2PiPi,cbmm-mc-2012-v14-BdToPiPi_2PiPtEtaFilter_8TeV-pythia6-evtgen__Summer12_DR53X-PU_S10_START53_V7A-v2-*,$version-cms-BdToPiPi.root"
    , "rare Bd2MuMuGamma MC"  
    => "-y 2012 -m,bmm2Reader.2e33-Bd2MuMuGamma,cbmm-mc-2012-v14-BdToMuMuGamma_MuMuEtaPtGammaFilter_8TeV-pythia6-evtgen__Summer12_DR53X-PU_S10_START53_V7A-v1-*,$version-cms-BdToMuMuGamma.root"
    , "rare Bd2MuMuPi0 MC"  
    => "-y 2012 -m,bmm2Reader.2e33-Bd2MuMuPi0,cbmm-mc-2012-v14-BdToMuMuPi0_MuMuPi0EtaPtFilter_8TeV-pythia6-evtgen__Summer12_DR53X-PU_S10_START53_V7A-v1-*,$version-cms-BdToMuMuPi0.root"
    , "rare Bd2MuMuK0 MC"  ###?
    => "-y 2012 -m,bmm2Reader.2e33-Bd2MuMuK0,cbmm-mc-2012-v14-BuToMuMuK0_MuMuK0EtaPtFilter_8TeV-pythia6-evtgen__Summer12_DR53X-PU_S10_START53_V7A-v1-*,$version-cms-BuToMuMuK0.root"
	#
    , "rare Bu2MuMuK MC"  
    => "-y 2012 -m,bmm2Reader.2e33-Bu2MuMuK,cbmm-mc-2012-v14-BuToMuMuK_MuMuKEtaPtFilter_8TeV-pythia6-evtgen__Summer12_DR53X-PU_S10_START53_V7A-v1-*,$version-cms-BuToMuMuK.root"
    , "rare Bu2MuMuPi MC"  
    => "-y 2012 -m,bmm2Reader.2e33-Bu2PiMuMu,cbmm-mc-2012-v14-BuToMuMuPi_MuMuPiEtaPtFilter_8TeV-pythia6-evtgen__Summer12_DR53X-PU_S10_START53_V7A-v1-*,$version-cms-BuToMuMuPi.root"
	#
    , "rare Lb2PK MC"  
    => "-y 2012 -m,bmm2Reader.2e33-Lb2KP,cbmm-mc-2012-v14-LambdaBToPK_PKPtEtaFilter_8TeV-pythia6-evtgen__Summer12_DR53X-PU_S10_START53_V7A-v2-*,$version-cms-LambdaBToPK.root"
    , "rare Lb2PiP MC"  
    => "-y 2012 -m,bmm2Reader.2e33-Lb2PiP,cbmm-mc-2012-v14-LambdaBToPPi_PPiPtEtaFilter_8TeV-pythia6-evtgen__Summer12_DR53X-PU_S10_START53_V7A-v1-*,$version-cms-LambdaBToPPi.root"
    , "rare Lb2PMuNu MC"  
    => "-y 2012 -m,bmm2Reader.2e33-Lb2PMuNu,cbmm-mc-2012-v14-LambdaBToPMuNu_PMuNuPtEtaFilter_8TeV-pythia6-evtgen__Summer12_DR53X-PU_S10_START53_V7A-v1-*,$version-cms-LambdaBToPMuNu.root"
    );

#my $user  = $ENV{'USER'};
my $user  = bstomumu;

my $tarfile = "../../../../../120416.tar.gz";
if ($opt_t) {
    $tarfile = $opt_t; 
} else {
    if ($opt_h) {
    } else {
	die "provide a tarfile!\n";
    }
}

my $crash = ""; 
if ($opt_C) {$crash = "-C";}

my $srmcmd  = "lcg-cp -b -D srmv2";
my $dcap    = "dcap://t3se01.psi.ch:22125/pnfs/psi.ch/cms/trivcat";
my $scratch = "/shome/lazo-flores/scratch"; # /scratch is likely too small
my $srm     = "srm://t3se01.psi.ch:8443/srm/managerv2\\?SFN=/pnfs/psi.ch/cms/trivcat/store";
my $storage = "$srm/user/$user/$rootdir";

#my $runCommand = "run $queue $crash -c ../../treeNoCompNoSE.csh -t $tarfile -m batch";
#my $runCommand = "run $crash -c ../../treeNoComp.csh -t $tarfile -m batch";
my $runCommand = "run $crash -c ../../treeNoCompSpecialRoot.csh -t $tarfile -m batch";


# ----------------------------------------------------------------------
# -- run hadd instead of submitting
if ($opt_h) {
    # print "srmls $storage | grep root\n";
    @lines = `srmls $storage | grep root`;
    #@lines = `ls $storage/* | grep root`;

    foreach $j (keys %jobs) {
	if ($opt_s =~ /signal/ && !($j =~ /signal/)) {next; }
	if ($opt_s =~ /cs/     && !($j =~ /cs/)) {next; }
	if ($opt_s =~ /norm/   && !($j =~ /norm/)) {next; }
	if ($opt_s =~ /data/   && !($j =~ /data/)) {next; }
	if ($opt_s =~ /mc/     && !($j =~ /MC/)) {next; }
	if ($opt_s =~ /rare/   && !($j =~ /rare/)) {next; }
	#if ($opt_s =~ /acc/    && !($j =~ /acc/)) {next; }
	#if ($opt_s =~ /bmt/    && !($j =~ /bmt/)) {next; }
	# -- skip bmt jobs if not explicitely requested
	if (!($opt_s =~ /bmt/) && ($j =~ /bmt/)) {next; }

	($options, $cutfile, $dataset, $output) = split(/,/, $jobs{$j});
	
	$dataset =~ s/-\*//;
	$dataset =~ s/\*/.\*/g;
	print "dataset = $dataset\n";
	print "file = $output\n";
	@rootfiles = grep(/$dataset/, @lines); 
	@rootfiles = grep(/\.root/, @rootfiles); 
	@rootfiles = grep(s/\n//, @rootfiles); 
	if ($#rootfiles == 0) {
	    @rootfiles = grep(s/.*$user\/$rootdir\///, @rootfiles); 
	    if ($opt_d) {
		# print "cp $rootfiles[0] $scratch/$output \n";
		print "===> In here!! \n";
		print "$srmcmd $storage/$rootfiles[0] $storage/$output \n";
		print "$srmcmd $storage/$rootfiles[0] file:///$scratch/$output \n";
	    } else {
		# print "cp $rootfiles[0] $scratch/$output \n";
		# system("/bin/cp $rootfiles[0] $scratch/$output");
		print "$srmcmd $storage/$rootfiles[0] $storage/$output \n";
		system("$srmcmd $storage/$rootfiles[0] $storage/$output");
		print "$srmcmd $storage/$rootfiles[0] file:///$scratch/$output \n";
		system("$srmcmd $storage/$rootfiles[0] file:///$scratch/$output");
	    }	    
	} elsif ($#rootfiles > 0) {
	    @rootfiles = grep(s/.*\/trivcat/$dcap/, @rootfiles); 
		@files12b = `ls $scratch | grep v12-2012B`;#
		@rootfiles12b = grep($scratch, @files12b);#

	    if ($opt_d) {
		print "hadd $scratch/$output \n";
		foreach $f (@rootfiles) {print "  $f\n";}
		print "hadd $scratch/v12-2012B-data.root \n";#
		foreach $f (@rootfiles12b) {print " $f\n";}#
	    } else {
		print "hadd $scratch/$output @rootfiles\n";
		if (-e "$scratch/$output") {unlink("$scratch/$output"); }
		system("hadd $scratch/$output @rootfiles");
		system("srmrm $storage/$class/$output");
		system("$srmcmd $scratch/$output $storage/$class/$output");
	    }
	}
    }
    
    die "that's it \n";
}


# ----------------------------------------------------------------------
# -- submit the jobs
foreach $j (keys %jobs) {
    ($options, $cutfile, $dataset, $output) = split(/,/, $jobs{$j});
    if ($opt_s =~ /data/   && !($j =~ /data/)) {next; }
    if ($opt_s =~ /norm/   && !($j =~ /norm/)) {next; }
    if ($opt_s =~ /signal/ && !($j =~ /signal/)) {next; }
    if ($opt_s =~ /cs/     && !($j =~ /cs/)) {next; }
    if ($opt_s =~ /mc/     && !($j =~ /MC/)) {next; }
    if ($opt_s =~ /rare/   && !($j =~ /rare/)) {next; }
    #if ($opt_s =~ /acc/    && !($j =~ /acc/)) {next; }
    # -- skip bmt jobs if not explicitely requested
    if (!($opt_s =~ /bmt/) && ($j =~ /bmt/)) {next; }  

    if ($j =~ /data/) {
	$command = "$runCommand -q all.q -x 'bin/runBmm2 $options -C cuts/$cutfile' -r 'STORAGE1 $storage/$class' ./$dataset"; 
    } else {
	$command = "$runCommand -q all.q -x 'bin/runBmm2 $options -C cuts/$cutfile' -r 'STORAGE1 $storage/$class' ./$dataset"; 
    }

    if ($opt_d) {
	print "$j \n$command\n";
    } else {
	print "$command\n";
	system($command);
    }

}

