#!/usr/bin/env perl

# Usage: cd chains/subdir; runAll -t tarfile [-h] [-m] [-n] [-r] [-a] [-d]
# ------
#            -d                           printout only, don't do anything
#            -h                           hadd the output rootfiles
#            -C                           run crashed jobs
#            -s {mc,data,signal,norm,cs}  run jobs of a specific sample
#            -r rootdir                   place where to put output
#
# 2010/11/23 first shot
# 2010/11/25 remove inclusion of old merged file in dataset-* list ...
# 2010/12/14 bug fix to allow really n wildcards (in addition to the trailing -*)
# 2011/05/17 added rare backgrounds
# 2011/05/26 realized that same dataset name will lead to problems on identical WN!
# ----------------------------------------------------------------------
# Send all questions, wishes and complaints to the 
#
# Author    Urs Langenegger <urs.langenegger@psi.ch>
# ----------------------------------------------------------------------
use Getopt::Std;
getopts('Cdhj:q:r:s:t:');

my $job = "2011";
if ($opt_j) {
    $job = $opt_j; 
}

my $rootdir = "bmm/$job"; 
if ($opt_r) {
    $rootdir = $opt_r; 
}


my %jobs = (
    "signal Bs2MuMu MC 5e32"  
    => "-m,bmmSignalReader,bmmBs2MuMuReader.mc-5e32.cuts,cv02-signal-Bs2MuMu-5e32,signalMC2011-5e32.root"
    , "signal Bs2MuMu MC 1e33"  
    => "-m,bmmSignalReader,bmmBs2MuMuReader.mc-1e33.cuts,cv02-signal-Bs2MuMu-1e33,signalMC2011.root"
    , "signal Bd2MuMu MC 5e32"  
    => "-m,bmmSignalReader,bmmBd2MuMuReader.mc-5e32.cuts,cv02-signal-Bd2MuMu-5e32,Bd2MuMu2011-5e32.root"
    , "signal Bd2MuMu MC 1e33"  
    => "-m,bmmSignalReader,bmmBd2MuMuReader.mc-1e33.cuts,cv02-signal-Bd2MuMu-1e33,Bd2MuMu2011.root"
    , "signal Bd2MuMu MC Summer11"  
    => "-m,bmmSignalReader,bmmBd2MuMuReader.mc-summer11.cuts,cn-00-BdToMuMu-Summer11,Bd2MuMu-Summer11.root"
# -- signal bg mc
    , "signal bg MC 60" => "-m,bmmSignalReader,bmm-bg60-LambdaB2PPiReader.$job.cuts,cv02-signal-bg60-LambdaB2PPi-5e32,bg60.root"
    , "signal bg MC 61" => "-m,bmmSignalReader,bmm-bg61-LambdaB2PKReader.$job.cuts,cv02-signal-bg61-LambdaB2PK-5e32,bg61.root"
    , "signal bg MC 82" => "-m,bmmSignalReader,bmm-bg82-Bs2KKReader.$job.cuts,cv02-signal-bg82-Bs2KK-5e32,bg82.root"
    , "signal bg MC 83" => "-m,bmmSignalReader,bmm-bg83-Bs2KPiReader.$job.cuts,cv02-signal-bg83-Bs2KPi-5e32,bg83.root"
    , "signal bg MC 84" => "-m,bmmSignalReader,bmm-bg84-Bs2PiPiReader.$job.cuts,cv02-signal-bg84-Bs2PiPi-5e32,bg84.root"
    , "signal bg MC 93" => "-m,bmmSignalReader,bmm-bg93-Bd2KKReader.$job.cuts,cv02-signal-bg93-Bd2KK-5e32,bg93.root"
    , "signal bg MC 92" => "-m,bmmSignalReader,bmm-bg92-Bd2KPiReader.$job.cuts,cv02-signal-bg92-Bd2KPi-5e32,bg92.root"
    , "signal bg MC 91" => "-m,bmmSignalReader,bmm-bg91-Bd2PiPiReader.$job.cuts,cv02-signal-bg91-Bd2PiPi-5e32,bg91.root"
# -- signal data
    , "signal data" 
    => "-b 1,bmmSignalReader,bmmSignalReader.$job.cuts,cv02-signal-MuOnia-Run2011A*,signalData2011.root"
# -- normalization
    , "norm MC 1e33" 
    => "-m,bmmNormalizationReader,bmmNormalizationReader.mc-1e33.cuts,cv02-norm-Bu2JpsiK-1e33-*,normMC2011.root"
    , "norm MC 5e32" 
    => "-m,bmmNormalizationReader,bmmNormalizationReader.mc-5e32.cuts,cv02-norm-Bu2JpsiK-5e32-*,normMC2011-5e32.root"
    , "norm MC Summer11" 
    => "-m,bmmNormalizationReader,bmmNormalizationReader.mc-summer11.cuts,cn-00-BpToPsiMuMu-Summer11-*,normMC-Summer11.root"
    , "norm data" 
    => "-b 0,bmmNormalizationReader,bmmNormalizationReader.$job.cuts,cv02-norm-MuOnia-Run2011A*,normData2011.root"
# -- control sample
    , "cs MC 1e33" 
    => "-m,bmmBs2JpsiPhiReader,bmmBs2JpsiPhiReader.mc-1e33.cuts,cv02-cs-Bs2JpsiPhi-1e33,Bs2JpsiPhiMC2011.root"
    , "cs MC 5e32" 
    => "-m,bmmBs2JpsiPhiReader,bmmBs2JpsiPhiReader.mc-5e32.cuts,cv02-cs-Bs2JpsiPhi-5e32,Bs2JpsiPhiMC2011-5e32.root"
    , "cs MC Summer11" 
    => "-m,bmmBs2JpsiPhiReader,bmmBs2JpsiPhiReader.mc-summer11.cuts,cn-00-BsToPsiMuMu-Summer11-*,Bs2JpsiPhiMC-Summer11.root"
    , "cs data" 
    => "-b 0,bmmBs2JpsiPhiReader,bmmBs2JpsiPhiReader.$job.cuts,cv02-cs-MuOnia-Run2011A*,Bs2JpsiPhiData2011.root"
    );

my $user  = $ENV{'USER'};

my $tarfile = "../../../../../101123.tar.gz";
if ($opt_t) {
    $tarfile = $opt_t; 
} else {
    if ($opt_h) {
    } else {
	die "provide a tarfile!\n";
    }
}

my $crash = ""; 
if ($opt_C) {$crash = "-C";}

my $queue = ""; 
if (!$opt_q && !opt_h) {
    print "-q not set\n";
    $queue = "-q all.q";
} else {
    $queue = "-q $opt_q";
}

my $storage = "/shome/ursl/scratch/$rootdir";
my $srmcmd = "srmcp -2 --streams_num=1";
my $dcap = "dcap://t3se01.psi.ch:22125/pnfs/psi.ch/cms/trivcat";
#my $scratch = "/scratch/$user"; 
my $scratch = "/shome/$user/scratch"; 

my $runCommand = "run $queue $crash -c ../../treeNoCompNoSE.csh -t $tarfile -m batch";


# ----------------------------------------------------------------------
# -- run hadd instead of submitting
if ($opt_h) {
    foreach $j (keys %jobs) {
	if ($opt_s =~ /signal/ && !($j =~ /signal/)) {next; }
	if ($opt_s =~ /cs/     && !($j =~ /cs/)) {next; }
	if ($opt_s =~ /norm/   && !($j =~ /norm/)) {next; }
	if ($opt_s =~ /data/   && !($j =~ /data/)) {next; }
	if ($opt_s =~ /mc/     && !($j =~ /MC/)) {next; }
	($options, $class, $cutfile, $dataset, $output) = split(/,/, $jobs{$j});
	#@lines = `srmls $storage/$class | grep root`;
	@lines = `ls $storage/$class/* | grep root`;

	$dataset =~ s/-\*//;
	$dataset =~ s/\*/.\*/g;
	print "dataset = $dataset\n";
	print "file = $output\n";
	@rootfiles = grep(/$dataset/, @lines); 
	@rootfiles = grep(/\.root/, @rootfiles); 
	#@rootfiles = grep(s/.*\/trivcat/$dcap/, @rootfiles); 
	@rootfiles = grep(s/\n//, @rootfiles); 
	if ($#rootfiles > -1) {
	    if ($opt_d) {
		print "hadd $scratch/$output \n";
		foreach $f (@rootfiles) {print "  $f\n";}
	    } else {
		print "hadd $scratch/$output @rootfiles\n";
		if (-e "$scratch/$output") {unlink("/scratch/$user/$output"); }
		system("hadd $scratch/$output @rootfiles");
		#system("srmrm $storage/$class/$output");
		#system("$srmcmd file:///$scratch/$output $storage/$class/$output");
	    }
	}
    }
    
    die "that's it \n";
}


# ----------------------------------------------------------------------
# -- submit the jobs
foreach $j (keys %jobs) {
    ($options, $class, $cutfile, $dataset, $output) = split(/,/, $jobs{$j});
    $command = "$runCommand -x 'bin/runTreeReaders -r $class $options -C cuts/$cutfile' -r 'STORAGE1 $storage/$class' ./$dataset"; 
    if ($opt_s =~ /data/   && !($j =~ /data/)) {next; }
    if ($opt_s =~ /norm/   && !($j =~ /norm/)) {next; }
    if ($opt_s =~ /signal/ && !($j =~ /signal/)) {next; }
    if ($opt_s =~ /cs/     && !($j =~ /cs/)) {next; }
    if ($opt_s =~ /mc/     && !($j =~ /MC/)) {next; }

    if ($opt_d) {
	print "$j \n$command\n";
    } else {
	print "$command\n";
	system($command);
    }

}

